name: Devnet HTTP Health (non-SSH)

on:
  workflow_dispatch: {}
  schedule:
    # Every 6 hours
    - cron: "0 */6 * * *"

jobs:
  devnet-http-health:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check devnet RPC endpoints (status/peers/time)
        shell: bash
        run: |
          set -euo pipefail
          ips=(5.223.51.238 188.245.97.41 135.181.145.174 178.156.219.107)
          port=8080
          expected_peers=4
          curl_opts=(--fail --silent --show-error --connect-timeout 3 --max-time 5 --retry 3 --retry-delay 1 --retry-all-errors)

          for ip in "${ips[@]}"; do
            echo "=== ${ip}:${port} ==="

            status_json="$(curl "${curl_opts[@]}" "http://${ip}:${port}/status")"
            status="$(jq -er '.status' <<<"$status_json")"
            peer_count="$(jq -er '.peer_count' <<<"$status_json")"
            version="$(jq -r '.version // empty' <<<"$status_json")"
            build_sha="$(jq -r '.build_sha // empty' <<<"$status_json")"

            if [[ "$status" != "ok" ]]; then
              echo "FAIL: status != ok (got: $status)"
              echo "status_json=${status_json}"
              exit 1
            fi

            peers_json="$(curl "${curl_opts[@]}" "http://${ip}:${port}/peers")"
            peers_len="$(jq -er 'length' <<<"$peers_json")"
            if [[ "$peers_len" -ne "$expected_peers" ]]; then
              echo "FAIL: peers_len != ${expected_peers} (got: $peers_len)"
              echo "peers_json=${peers_json}"
              exit 1
            fi

            time_json="$(curl "${curl_opts[@]}" "http://${ip}:${port}/time")"
            time_us="$(jq -er '.time_us' <<<"$time_json")"
            if ! [[ "$time_us" =~ ^[0-9]+$ ]]; then
              echo "FAIL: time_us not integer (got: $time_us)"
              echo "time_json=${time_json}"
              exit 1
            fi

            # Always print a concise, debuggable per-node summary line.
            echo "node=${ip} status=${status} peer_count=${peer_count} peers_len=${peers_len} time_us=${time_us} version=${version} build_sha=${build_sha}"
          done


