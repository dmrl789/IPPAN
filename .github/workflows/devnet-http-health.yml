name: Devnet HTTP Health (non-SSH)

on:
  workflow_dispatch: {}
  schedule:
    # Every 6 hours
    - cron: "0 */6 * * *"

jobs:
  devnet-http-health:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check devnet RPC endpoints (status/peers/time)
        shell: bash
        run: |
          set -euo pipefail
          ips=(5.223.51.238 188.245.97.41 135.181.145.174 178.156.219.107)
          port=8080
          expected_peers=4
          curl_opts=(--fail --silent --show-error --connect-timeout 3 --max-time 5 --retry 3 --retry-delay 1 --retry-all-errors)

          for ip in "${ips[@]}"; do
            echo "=== ${ip}:${port} ==="

            status="$(curl "${curl_opts[@]}" "http://${ip}:${port}/status" | jq -er '.status')"
            if [[ "$status" != "ok" ]]; then
              echo "FAIL: status != ok (got: $status)"
              exit 1
            fi

            peers_len="$(curl "${curl_opts[@]}" "http://${ip}:${port}/peers" | jq -er 'length')"
            if [[ "$peers_len" -ne "$expected_peers" ]]; then
              echo "FAIL: peers_len != ${expected_peers} (got: $peers_len)"
              exit 1
            fi

            time_us="$(curl "${curl_opts[@]}" "http://${ip}:${port}/time" | jq -er '.time_us')"
            if ! [[ "$time_us" =~ ^[0-9]+$ ]]; then
              echo "FAIL: time_us not integer (got: $time_us)"
              exit 1
            fi
          done


