name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write
  checks: write

jobs:
  security-scan:
    name: Dependency & Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------
      # 1Ô∏è‚É£ Rust: cargo-deny advisories + licenses
      # -------------------------------
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Rust Security & License Check
        run: |
          echo "üîç Running cargo-deny checks..."
          cargo deny check --config deny.toml 2>&1 | tee deny-output.txt
          exit_code=${PIPESTATUS[0]}
          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ All cargo-deny checks passed"
          elif [ $exit_code -eq 1 ]; then
            echo "‚ö†Ô∏è Warnings found but continuing"
            exit 0
          else
            echo "‚ùå Errors found"
            exit $exit_code
          fi

      # -------------------------------
      # 2Ô∏è‚É£ Node.js: npm audit + license compliance
      # -------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/gateway/package-lock.json

      - name: Node.js Security Audit
        if: always()
        run: |
          if [ -d "apps/gateway" ]; then
            cd apps/gateway
            echo "üîç Running npm audit..."
            npm ci --no-audit --no-fund
            npm audit --audit-level=moderate --json > audit-results.json 2>&1 || true

            critical=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json 2>/dev/null || echo 0)
            if [ "$critical" -gt 0 ]; then
              echo "‚ö†Ô∏è Found $critical critical vulnerabilities in Node.js dependencies"
            else
              echo "‚úÖ No critical vulnerabilities"
            fi
          else
            echo "‚ÑπÔ∏è No Node.js gateway found, skipping audit"
          fi

      - name: Node.js License Check
        if: always()
        run: |
          if [ -d "apps/gateway" ] && [ -f "apps/gateway/package.json" ]; then
            cd apps/gateway
            echo "üîç Checking package licenses..."
            npx license-checker \
              --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Unlicense;MPL-2.0;CC0-1.0' || true
          else
            echo "‚ÑπÔ∏è No Node.js gateway found, skipping license check"
          fi

      # -------------------------------
      # 3Ô∏è‚É£ Upload reports for inspection
      # -------------------------------
      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            deny-output.txt
            apps/gateway/audit-results.json
          retention-days: 30
          if-no-files-found: warn
