name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Rust Security & License Check
        run: |
          # Run cargo deny with proper error handling
          # This checks advisories, licenses, bans, and sources
          cargo deny check --config deny.toml 2>&1 | tee deny-output.txt
          
          # cargo deny exits with error codes:
          # 0 = success
          # 1 = warnings found (we'll allow this)
          # 2+ = errors found (we'll fail on this)
          exit_code=${PIPESTATUS[0]}
          
          if [ $exit_code -eq 0 ]; then
            echo "✅ All checks passed"
            exit 0
          elif [ $exit_code -eq 1 ]; then
            echo "⚠️ Warnings found but continuing"
            exit 0
          else
            echo "❌ Errors found"
            exit $exit_code
          fi

      - name: Node.js Security Audit
        if: always()
        run: |
          if [ -d "apps/gateway" ]; then
            cd apps/gateway
            # Create audit results file even if audit fails
            npm audit --audit-level=moderate --json > audit-results.json 2>&1 || true
            
            # Check for critical vulnerabilities
            critical_count=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json 2>/dev/null || echo "0")
            if [ "$critical_count" -gt 0 ]; then
              echo "⚠️ Found $critical_count critical vulnerabilities in Node.js dependencies"
              # Don't fail the build, just warn
            fi
          else
            echo "ℹ️ No Node.js gateway found, skipping Node.js audit"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: |
            deny-output.txt
            apps/gateway/audit-results.json
          retention-days: 30
          if-no-files-found: warn

      - name: Node.js License Check
        if: always()
        run: |
          if [ -d "apps/gateway" ] && [ -f "apps/gateway/package.json" ]; then
            cd apps/gateway
            npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Unlicense;MPL-2.0;CC0-1.0' || true
          else
            echo "ℹ️ No Node.js gateway found, skipping license check"
          fi
