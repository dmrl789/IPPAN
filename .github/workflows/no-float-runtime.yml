name: üßÆ No Floats in Runtime

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test-no-float-runtime:
    name: Ensure runtime crates have no f32/f64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          if ! command -v rg >/dev/null 2>&1; then
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ripgrep
          fi

      - name: Check for forbidden f32 in runtime crates
        run: |
          echo "Checking for f32 in runtime crates (excluding tests/examples/benches, ignoring comments)..."

          # Collect matches (if any) without failing when none are found.
          matches=$(rg '\bf32\b' \
              crates/ai_core/src \
              crates/consensus/src \
              crates/consensus_dlc/src \
              crates/ai_registry/src \
              --glob '!**/tests/**' \
              --glob '!**/examples/**' \
              --glob '!**/benches/**' \
              -n || true)

          # Filter out lines that are purely comments (// or ///).
          matches=$(echo "$matches" | grep -Ev '^\s*//' || true)

          if [ -n "$matches" ]; then
            echo "‚ùå Found forbidden f32 usage in runtime crates:"
            echo "$matches"
            exit 1
          else
            echo "‚úÖ No non-comment f32 usage found in runtime crates."
          fi

      - name: Check for forbidden f64 in runtime crates
        run: |
          echo "Checking for f64 in runtime crates (excluding tests/examples/benches, ignoring comments)..."

          matches=$(rg '\bf64\b' \
              crates/ai_core/src \
              crates/consensus/src \
              crates/consensus_dlc/src \
              crates/ai_registry/src \
              --glob '!**/tests/**' \
              --glob '!**/examples/**' \
              --glob '!**/benches/**' \
              -n || true)

          matches=$(echo "$matches" | grep -Ev '^\s*//' || true)

          if [ -n "$matches" ]; then
            echo "‚ùå Found forbidden f64 usage in runtime crates:"
            echo "$matches"
            exit 1
          else
            echo "‚úÖ No non-comment f64 usage found in runtime crates."
          fi
