name: üßÆ No Floats in Runtime

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  test-no-float-runtime:
    name: Ensure runtime crates have no f32/f64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          if ! command -v rg >/dev/null 2>&1; then
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ripgrep
          fi

      - name: Check for forbidden floats in runtime crates
        run: |
          set -euo pipefail
          echo "Checking for f32/f64 in runtime crates (.rs only, excluding tests/examples/benches)..."

          runtime_paths=(
            crates/types/src
            crates/core/src
            crates/time/src
            crates/consensus/src
            crates/consensus_dlc/src
            crates/mempool/src
            crates/storage/src
            crates/network/src
            crates/p2p/src
            crates/rpc/src
            crates/security/src
            crates/governance/src
            crates/economics/src
            crates/ippan_economics/src
            crates/treasury/src
            crates/l1_fees/src
            crates/l2_fees/src
            crates/l2_handle_registry/src
            crates/l1_handle_anchors/src
            crates/validator_resolution/src
            crates/files/src
            crates/ai_core/src
            crates/ai_registry/src
            node/src
          )

          matches=$(rg \
              --glob '*.rs' \
              --glob '!**/tests/**' \
              --glob '!**/examples/**' \
              --glob '!**/benches/**' \
              -n \
              '\b(f32|f64)\b' \
              "${runtime_paths[@]}" || true)

          matches=$(echo "$matches" | grep -Ev '^\s*//' || true)

          if [ -n "$matches" ]; then
            echo "‚ùå Found forbidden float usage in runtime crates:"
            echo "$matches"
            exit 1
          else
            echo "‚úÖ No forbidden f32/f64 usage detected in runtime crates."
          fi
