name: "ğŸ§ª IPPAN CI Diagnostic Suite"

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop

permissions:
  contents: read
  actions: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  RUSTFLAGS: "-D warnings"
  NODE_ENV: production

jobs:
  diagnostics:
    name: "ğŸ” Full Diagnostic Run"
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: "ğŸ› ï¸ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ§© Setup Rust"
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: "ğŸ¦€ Rust environment info"
        run: |
          rustc --version
          cargo --version
          echo "Target triple: $(rustc -vV | grep host)"
          df -h

      - name: "ğŸ§¹ Cargo clean"
        run: cargo clean || true

      - name: "âš™ï¸ Cargo check (all crates)"
        run: cargo check --workspace --all-targets --verbose

      - name: "ğŸ§¾ Cargo fmt + Clippy"
        run: |
          cargo fmt --all -- --check || true
          cargo clippy --workspace --all-targets --all-features --no-deps || true

      - name: "ğŸ§ª Run determinism tests (x86_64)"
        run: |
          echo "=== Running Determinism Tests (x86_64) ==="
          cargo test -p ippan-ai-core -- --nocapture || true
          cargo test -p ippan-consensus -- --nocapture || true

      - name: "ğŸ§ª Scan for float usage"
        run: |
          echo "=== Searching for non-deterministic float usage ==="
          rg "f32|f64|as f32|as f64" crates/ai_core crates/consensus || echo "âœ… No floating-point types detected"

      - name: "ğŸ³ Docker build diagnostics"
        run: |
          echo "=== Docker Build (ippan) ==="
          docker build -f Dockerfile . --progress=plain || true
          echo "=== Docker Build (gateway) ==="
          docker build -f apps/gateway/Dockerfile apps/gateway --progress=plain || true

      - name: "ğŸŒ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: "ğŸ“¦ Install Gateway deps"
        working-directory: apps/gateway
        run: npm ci || npm install

      - name: "ğŸ§° Gateway lint & build"
        working-directory: apps/gateway
        run: |
          echo "=== Linting ==="
          npm run lint || true
          echo "=== Building ==="
          npm run build || true

      - name: "ğŸ”’ Dependency & security scan"
        run: |
          cargo audit || true
          npm audit || true

      - name: "ğŸ§¾ Gather environment summary"
        run: |
          echo "=== Environment Summary ==="
          echo "Git commit: $(git rev-parse HEAD)"
          echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Crates:"
          cargo metadata --no-deps --format-version 1 | jq '.packages[].name'
          echo "Node packages:"
          jq '.dependencies | keys' apps/gateway/package.json

      - name: "ğŸ“¦ Upload diagnostic logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ippan-ci-diagnostics
          path: |
            target/debug/deps/**/*.log
            apps/gateway/.next
            apps/gateway/dist
            docker-build.log
            **/Cargo.lock
            **/package-lock.json
          retention-days: 7
