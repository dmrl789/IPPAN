name: Check Nodes (UI & API Health)

on:
  workflow_dispatch:
    inputs:
      ui_url:
        description: "UI base URL to check (e.g., https://ui.ippan.org)"
        required: false
        default: ""
      api_base:
        description: "API base URL to check (e.g., https://ui.ippan.org/api)"
        required: false
        default: ""
  schedule:
    # Runs every 30 minutes
    - cron: "*/30 * * * *"

jobs:
  health-check:
    name: Node Health Check
    runs-on: ubuntu-latest

    env:
      UI_URL: ${{ inputs.ui_url != '' && inputs.ui_url || vars.NEXT_PUBLIC_GATEWAY_URL }}
      API_BASE: ${{ inputs.api_base != '' && inputs.api_base || vars.NEXT_PUBLIC_API_BASE_URL }}

    steps:
      - name: Display effective targets
        run: |
          echo "UI_URL=${UI_URL}"
          echo "API_BASE=${API_BASE}"
          if [ -z "${UI_URL}" ] || [ -z "${API_BASE}" ]; then
            echo "::error::UI_URL or API_BASE is empty. Provide inputs or define repo Variables: NEXT_PUBLIC_GATEWAY_URL, NEXT_PUBLIC_API_BASE_URL."
            exit 1
          fi

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl jq

      - name: Check DNS & HTTPS (UI)
        run: |
          set -euo pipefail
          echo "Checking UI endpoint: ${UI_URL}"
          if curl -fsSLI "${UI_URL}" >/dev/null; then
            echo "✅ UI reachable"
          else
            echo "::error::UI not reachable at ${UI_URL}"
            exit 1
          fi

      - name: Check API /health (retry up to 3 times)
        run: |
          set -euo pipefail
          tries=0
          until [ $tries -ge 3 ]; do
            echo "Probe $((tries+1))/3: ${API_BASE}/health"
            if curl -fsSL "${API_BASE}/health" -o health.json && jq -e '.status=="healthy"' health.json >/dev/null; then
              echo "✅ API health OK"
              exit 0
            fi
            tries=$((tries+1))
            echo "Health check failed; retrying in 5 seconds..."
            sleep 5
          done

          echo "::error::API health check failed after 3 attempts."
          echo "Last response (if any):"
          cat health.json || echo "No response."
          exit 1

      - name: Optional API /status summary
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "Fetching ${API_BASE}/status (non-fatal)..."
          curl -fsSL "${API_BASE}/status" | jq '.' || true
