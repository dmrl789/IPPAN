name: Apply Patch From Issue

on:
  issues:
    types: [opened, edited, reopened, labeled]

# Avoid overlapping runs on the same issue
concurrency:
  group: apply-patch-${{ github.event.issue.number }}
  cancel-in-progress: true

# Default shell for all run steps
defaults:
  run:
    shell: bash

jobs:
  apply:
    if: contains(github.event.issue.labels.*.name, 'auto-patch')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_TOKEN }}  # PAT with repo access
          fetch-depth: 0                  # needed for 3-way apply

      - name: Extract patch from issue body
        id: extract
        env:
          BODY: ${{ github.event.issue.body }}
        run: |
          python3 - <<'PY'
          import os, re, sys
          body = os.environ.get('BODY', '')
          # Prefer fenced code blocks tagged diff/patch; otherwise consider whole body
          blocks = re.findall(r"```(?:diff|patch)?\n(.*?)```", body, flags=re.S)
          candidates = blocks + [body]
          patch = next((c for c in candidates
                        if 'diff --git ' in c or c.lstrip().startswith(('--- ', 'From '))), None)
          if not patch:
              print("No unified diff found in issue body.")
              sys.exit(1)
          with open("change.patch", "w", encoding="utf-8") as f:
            f.write(patch)
          PY

      - name: Configure Git
        run: |
          git config user.name "ippan-auto-bot"
          git config user.email "actions@users.noreply.github.com"

      - name: Create branch
        run: |
          BR="auto/patch-${{ github.event.issue.number }}"
          echo "BRANCH=$BR" >> "$GITHUB_ENV"
          git checkout -b "$BR"

      - name: Try applying patch (3-way), fall back to normal
        run: |
          set -e
          if ! git apply --index --3way change.patch; then
            echo "::warning::3-way apply failed; retrying without 3-way"
            git reset --hard
            git apply --index change.patch
          fi

      - name: Commit changes (if any)
        run: |
          if git diff --cached --quiet; then
            echo "No changes staged; patch might already be applied."
            exit 0
          fi
          git commit -m "Apply patch from #${{ github.event.issue.number }}"

      - name: Push branch
        run: |
          if git rev-parse --verify HEAD >/dev/null 2>&1; then
            git push -u origin "$BRANCH"
          fi

      - name: Open PR
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.BOT_TOKEN }}
          branch: ${{ env.BRANCH }}
          title: "Apply patch from #${{ github.event.issue.number }}"
          body: |
            Automated PR created from Issue #${{ github.event.issue.number }}.
            Patch was applied by GitHub Actions.
          commit-message: "Apply patch from #${{ github.event.issue.number }}"
          labels: auto-patch
