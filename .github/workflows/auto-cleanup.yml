name: Auto Cleanup

on:
  schedule:
    - cron: '0 5 * * 0'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 14
          keep_minimum_runs: 10
      - name: Delete merged branches
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const defaultBranch = (await github.rest.repos.get({ owner, repo })).data.default_branch;

            // List closed PRs merged recently (limit 100). Adjust if needed.
            const prs = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: "closed", per_page: 100
            });

            let deleted = 0;
            for (const pr of prs) {
              if (!pr.merged_at) continue;
              const ref = pr.head.ref;
              if (!ref || ref === defaultBranch) continue;

              // Only delete branches in the same repo (not forks)
              if (pr.head.repo.full_name !== `${owner}/${repo}`) continue;

              try {
                await github.rest.git.deleteRef({ owner, repo, ref: `heads/${ref}` });
                deleted++;
              } catch (e) {
                // ignore if already deleted or protected
              }
            }
            core.info(`Deleted ${deleted} merged branches`);
