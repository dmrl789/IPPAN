name: Nightly Full Validation

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      upload_coverage:
        description: 'Upload coverage to artifacts'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  RUSTFLAGS: "-D warnings"
  CARGO_TERM_COLOR: always

jobs:
  full-test-suite:
    name: Full Workspace Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      status: ${{ steps.test_results.outputs.status }}
      passed: ${{ steps.test_results.outputs.passed }}
      failed: ${{ steps.test_results.outputs.failed }}
      total: ${{ steps.test_results.outputs.total }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Run cargo test --workspace
        run: |
          echo "Running full workspace test suite..."
          cargo test --workspace --all-features --no-fail-fast -- --nocapture 2>&1 | tee test-output.log
        continue-on-error: true
        id: cargo_test

      - name: Parse test results
        id: test_results
        run: |
          if [ -f test-output.log ]; then
            passed=$(grep -c "test result: ok" test-output.log || echo "0")
            failed=$(grep "test result: FAILED" test-output.log | wc -l || echo "0")
            total_tests=$(grep -oP '\d+(?= passed)' test-output.log | head -1 || echo "0")

            echo "passed=$passed" >> "$GITHUB_OUTPUT"
            echo "failed=$failed" >> "$GITHUB_OUTPUT"
            echo "total=$total_tests" >> "$GITHUB_OUTPUT"

            if [ "$failed" -gt 0 ]; then
              echo "status=failed" >> "$GITHUB_OUTPUT"
            else
              echo "status=passed" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "status=unknown" >> "$GITHUB_OUTPUT"
            echo "passed=0" >> "$GITHUB_OUTPUT"
            echo "failed=0" >> "$GITHUB_OUTPUT"
            echo "total=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ github.run_number }}
          path: test-output.log
          retention-days: 30
          if-no-files-found: warn

  coverage-analysis:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 90
    needs: full-test-suite
    outputs:
      coverage: ${{ steps.coverage_results.outputs.coverage }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install cargo-tarpaulin
        run: |
          cargo install cargo-tarpaulin --locked

      - name: Run cargo tarpaulin
        run: |
          echo "Generating coverage report..."
          cargo tarpaulin \
            --workspace \
            --all-features \
            --timeout 600 \
            --out Xml \
            --out Json \
            --out Html \
            --output-dir coverage \
            --exclude-files "apps/*" \
            --exclude-files "examples/*" \
            --exclude-files "benches/*" \
            --exclude-files "tests/*" \
            --skip-clean \
            -- --test-threads 1
        continue-on-error: true
        id: tarpaulin

      - name: Parse coverage results
        id: coverage_results
        run: |
          if [ -f coverage/cobertura.xml ]; then
            # Extract coverage percentage from XML
            coverage=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1)
            coverage_percent=$(echo "$coverage * 100" | bc -l | xargs printf "%.2f")
            echo "coverage=$coverage_percent" >> "$GITHUB_OUTPUT"
          elif [ -f coverage/tarpaulin-report.json ]; then
            # Fallback to JSON parsing
            coverage=$(jq -r '.coverage' coverage/tarpaulin-report.json 2>/dev/null || echo "0")
            echo "coverage=$coverage" >> "$GITHUB_OUTPUT"
          else
            echo "coverage=0.00" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload coverage artifacts
        if: always() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.upload_coverage))
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: |
            coverage/
          retention-days: 90
          if-no-files-found: warn

      - name: Generate coverage badge
        if: always()
        run: |
          coverage="${{ steps.coverage_results.outputs.coverage }}"
          badge_color="red"

          if (( $(echo "$coverage >= 80" | bc -l) )); then
            badge_color="brightgreen"
          elif (( $(echo "$coverage >= 60" | bc -l) )); then
            badge_color="yellow"
          elif (( $(echo "$coverage >= 40" | bc -l) )); then
            badge_color="orange"
          fi

          echo "badge_color=$badge_color" >> "$GITHUB_ENV"
          echo "Coverage: ${coverage}% (${badge_color})"

  update-project-status:
    name: Update Project Status
    runs-on: ubuntu-latest
    needs: [full-test-suite, coverage-analysis]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download coverage results
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: coverage/
        continue-on-error: true

      - name: Calculate readiness score
        id: readiness
        run: |
          # Get coverage from previous job
          coverage="${{ needs.coverage-analysis.outputs.coverage || '0' }}"
          test_status="${{ needs.full-test-suite.outputs.status || 'unknown' }}"

          # Calculate readiness score (0-100)
          score=0

          # Coverage contributes 50 points max
          coverage_score=$(echo "$coverage * 0.5" | bc -l | xargs printf "%.0f")
          score=$((score + coverage_score))

          # Test passing contributes 30 points
          if [ "$test_status" = "passed" ]; then
            score=$((score + 30))
          fi

          # Build health contributes 20 points (assume healthy if we got here)
          score=$((score + 20))

          echo "score=$score" >> "$GITHUB_OUTPUT"
          echo "Readiness Score: $score/100"

          # Determine readiness level
          if [ "$score" -ge 90 ]; then
            readiness="Production Ready"
          elif [ "$score" -ge 70 ]; then
            readiness="Release Candidate"
          elif [ "$score" -ge 50 ]; then
            readiness="Beta"
          else
            readiness="Alpha"
          fi

          echo "readiness=$readiness" >> "$GITHUB_OUTPUT"

      - name: Update PROJECT_STATUS.md
        run: |
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          coverage="${{ needs.coverage-analysis.outputs.coverage || '0.00' }}"
          readiness_score="${{ steps.readiness.outputs.score }}"
          readiness_level="${{ steps.readiness.outputs.readiness }}"
          test_status="${{ needs.full-test-suite.outputs.status || 'unknown' }}"

          # Create or update PROJECT_STATUS.md
          cat > PROJECT_STATUS.md <<'STATUSEOF'
          # IPPAN Project Status

          > Last updated: TIMESTAMP_PLACEHOLDER
          > Generated by: [Nightly Full Validation](.github/workflows/nightly-validation.yml)

          ## ðŸ“Š Current Status

          | Metric | Value | Status |
          |--------|-------|--------|
          | **Readiness Level** | READINESS_LEVEL_PLACEHOLDER | READINESS_ICON_PLACEHOLDER |
          | **Readiness Score** | READINESS_SCORE_PLACEHOLDER/100 | SCORE_ICON_PLACEHOLDER |
          | **Code Coverage** | COVERAGE_PLACEHOLDER% | COVERAGE_ICON_PLACEHOLDER |
          | **Test Suite** | TEST_STATUS_PLACEHOLDER | TEST_ICON_PLACEHOLDER |
          | **CI/CD Status** | Stable | âœ… |

          ## ðŸ“ˆ Coverage Trend

          | Date | Coverage | Change | Readiness |
          |------|----------|--------|-----------|
          | DATE_PLACEHOLDER | COVERAGE_PLACEHOLDER% | - | READINESS_SCORE_PLACEHOLDER/100 |

          ## ðŸŽ¯ Readiness Criteria

          ### Production Ready (90-100 points)
          - [ ] Code coverage â‰¥ 80%
          - [ ] All tests passing
          - [ ] No critical vulnerabilities
          - [ ] Documentation complete
          - [ ] Performance benchmarks met

          ### Release Candidate (70-89 points)
          - [COVERAGE_60_PLACEHOLDER] Code coverage â‰¥ 60%
          - [TEST_PASSED_PLACEHOLDER] All tests passing
          - [ ] No high-severity vulnerabilities
          - [ ] Core documentation complete

          ### Beta (50-69 points)
          - [COVERAGE_40_PLACEHOLDER] Code coverage â‰¥ 40%
          - [ ] Core tests passing
          - [ ] Basic documentation

          ### Alpha (0-49 points)
          - [COVERAGE_GT0_PLACEHOLDER] Some test coverage
          - [ ] Basic functionality working

          ## ðŸ” Detailed Reports

          - [Latest Coverage Report](https://github.com/REPO_PLACEHOLDER/actions/runs/RUN_ID_PLACEHOLDER)
          - [Test Results](https://github.com/REPO_PLACEHOLDER/actions/workflows/nightly-validation.yml)
          - [Security Scans](https://github.com/REPO_PLACEHOLDER/actions/workflows/security-suite.yml)

          ## ðŸ“ Notes

          This status is automatically updated nightly by the CI/CD pipeline.
          For manual validation, run: \`cargo test --workspace && cargo tarpaulin\`

          ---

          *Generated by IPPAN Nightly Validation Pipeline*
          STATUSEOF

          # Replace placeholders
          sed -i "s|TIMESTAMP_PLACEHOLDER|${timestamp}|g" PROJECT_STATUS.md
          sed -i "s|READINESS_LEVEL_PLACEHOLDER|${readiness_level}|g" PROJECT_STATUS.md
          sed -i "s|READINESS_SCORE_PLACEHOLDER|${readiness_score}|g" PROJECT_STATUS.md
          sed -i "s|COVERAGE_PLACEHOLDER|${coverage}|g" PROJECT_STATUS.md
          sed -i "s|TEST_STATUS_PLACEHOLDER|${test_status}|g" PROJECT_STATUS.md
          sed -i "s|DATE_PLACEHOLDER|${timestamp%% *}|g" PROJECT_STATUS.md
          sed -i "s|REPO_PLACEHOLDER|${{ github.repository }}|g" PROJECT_STATUS.md
          sed -i "s|RUN_ID_PLACEHOLDER|${{ github.run_id }}|g" PROJECT_STATUS.md

          # Add icons based on values
          if [ "$readiness_score" -ge 70 ]; then
            sed -i "s|READINESS_ICON_PLACEHOLDER|âœ…|g" PROJECT_STATUS.md
          else
            sed -i "s|READINESS_ICON_PLACEHOLDER|âš ï¸|g" PROJECT_STATUS.md
          fi

          if [ "$readiness_score" -ge 90 ]; then
            sed -i "s|SCORE_ICON_PLACEHOLDER|ðŸŸ¢|g" PROJECT_STATUS.md
          elif [ "$readiness_score" -ge 70 ]; then
            sed -i "s|SCORE_ICON_PLACEHOLDER|ðŸŸ¡|g" PROJECT_STATUS.md
          else
            sed -i "s|SCORE_ICON_PLACEHOLDER|ðŸ”´|g" PROJECT_STATUS.md
          fi

          if (( $(echo "$coverage >= 80" | bc -l) )); then
            sed -i "s|COVERAGE_ICON_PLACEHOLDER|âœ…|g" PROJECT_STATUS.md
          elif (( $(echo "$coverage >= 60" | bc -l) )); then
            sed -i "s|COVERAGE_ICON_PLACEHOLDER|âš ï¸|g" PROJECT_STATUS.md
          else
            sed -i "s|COVERAGE_ICON_PLACEHOLDER|âŒ|g" PROJECT_STATUS.md
          fi

          if [ "$test_status" = "passed" ]; then
            sed -i "s|TEST_ICON_PLACEHOLDER|âœ…|g" PROJECT_STATUS.md
            sed -i "s|TEST_PASSED_PLACEHOLDER|x|g" PROJECT_STATUS.md
          else
            sed -i "s|TEST_ICON_PLACEHOLDER|âŒ|g" PROJECT_STATUS.md
            sed -i "s|TEST_PASSED_PLACEHOLDER| |g" PROJECT_STATUS.md
          fi

          if (( $(echo "$coverage >= 60" | bc -l) )); then
            sed -i "s|COVERAGE_60_PLACEHOLDER|x|g" PROJECT_STATUS.md
          else
            sed -i "s|COVERAGE_60_PLACEHOLDER| |g" PROJECT_STATUS.md
          fi

          if (( $(echo "$coverage >= 40" | bc -l) )); then
            sed -i "s|COVERAGE_40_PLACEHOLDER|x|g" PROJECT_STATUS.md
          else
            sed -i "s|COVERAGE_40_PLACEHOLDER| |g" PROJECT_STATUS.md
          fi

          if (( $(echo "$coverage > 0" | bc -l) )); then
            sed -i "s|COVERAGE_GT0_PLACEHOLDER|x|g" PROJECT_STATUS.md
          else
            sed -i "s|COVERAGE_GT0_PLACEHOLDER| |g" PROJECT_STATUS.md
          fi

          echo "âœ… PROJECT_STATUS.md updated successfully"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add PROJECT_STATUS.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            coverage="${{ needs.coverage-analysis.outputs.coverage }}"
            readiness="${{ steps.readiness.outputs.score }}"
            readiness_level="${{ steps.readiness.outputs.readiness }}"
            test_status="${{ needs.full-test-suite.outputs.status }}"
            run_number="${{ github.run_number }}"

            git commit -m "chore: update project status [skip ci]" \
              -m "" \
              -m "Coverage: ${coverage}%" \
              -m "Readiness: ${readiness}/100 (${readiness_level})" \
              -m "Tests: ${test_status}" \
              -m "" \
              -m "Generated by nightly validation run #${run_number}"

            git push origin ${{ github.ref_name }} || echo "âš ï¸ Failed to push changes"
          fi

      - name: Create summary
        if: always()
        run: |
          {
            echo "## ðŸŒ™ Nightly Validation Summary"
            echo ""
            echo "### Test Results"
            echo "- Status: ${{ needs.full-test-suite.outputs.status }}"
            echo ""
            echo "### Coverage"
            echo "- Coverage: ${{ needs.coverage-analysis.outputs.coverage }}%"
            echo ""
            echo "### Readiness"
            echo "- Score: ${{ steps.readiness.outputs.score }}/100"
            echo "- Level: ${{ steps.readiness.outputs.readiness }}"
            echo ""
            echo "### Artifacts"
            echo "- [Test Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo "- [Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> "$GITHUB_STEP_SUMMARY"
