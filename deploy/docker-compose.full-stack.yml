version: "3.9"

x-node-env: &node-env
  RPC_HOST: "0.0.0.0"
  RPC_PORT: "8080"
  P2P_HOST: "0.0.0.0"
  P2P_PORT: "9000"
  DATA_DIR: "/var/lib/ippan"
  DB_PATH: "/var/lib/ippan/db"
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"
  DEV_MODE: "true"
  ENABLE_SECURITY: "false"
  MAX_PEERS: "12"
  PEER_DISCOVERY_INTERVAL_SECS: "5"
  PEER_ANNOUNCE_INTERVAL_SECS: "5"
  P2P_ENABLE_UPNP: "false"

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  ippan-node-bootstrap:
    image: ippan-node:ci
    build:
      context: ..
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      <<: *node-env
      NODE_ID: "node-bootstrap"
      VALIDATOR_ID: "0000000000000000000000000000000000000000000000000000000000000001"
      BOOTSTRAP_NODES: ""
    ports:
      - "8080:8080"
      - "9000:9000"
    volumes:
      - node-bootstrap-data:/var/lib/ippan
    networks:
      - ippan-full-stack
    logging: *default-logging

  ippan-node-2:
    image: ippan-node:ci
    depends_on:
      - ippan-node-bootstrap
    restart: unless-stopped
    environment:
      <<: *node-env
      NODE_ID: "node-2"
      VALIDATOR_ID: "0000000000000000000000000000000000000000000000000000000000000002"
      BOOTSTRAP_NODES: "http://ippan-node-bootstrap:9000"
    ports:
      - "8081:8080"
      - "9001:9000"
    volumes:
      - node-2-data:/var/lib/ippan
    networks:
      - ippan-full-stack
    logging: *default-logging

  ippan-node-3:
    image: ippan-node:ci
    depends_on:
      - ippan-node-bootstrap
      - ippan-node-2
    restart: unless-stopped
    environment:
      <<: *node-env
      NODE_ID: "node-3"
      VALIDATOR_ID: "0000000000000000000000000000000000000000000000000000000000000003"
      BOOTSTRAP_NODES: "http://ippan-node-bootstrap:9000,http://ippan-node-2:9000"
    ports:
      - "8082:8080"
      - "9002:9000"
    volumes:
      - node-3-data:/var/lib/ippan
    networks:
      - ippan-full-stack
    logging: *default-logging

  ippan-gateway:
    image: ippan-gateway:ci
    build:
      context: ../apps/gateway
      dockerfile: Dockerfile
    depends_on:
      - ippan-node-bootstrap
    restart: unless-stopped
    environment:
      PORT: "7080"
      TARGET_RPC_URL: "http://ippan-node-bootstrap:8080"
      TARGET_WS_URL: "ws://ippan-node-bootstrap:8080/ws"
      TARGET_HEALTH_PATH: "/health"
      API_PREFIX: "/api"
      WS_PREFIX: "/ws"
      ENABLE_EXPLORER: "true"
      EXPLORER_PREFIX: "/explorer/api"
      ALLOWED_ORIGINS: "*"
      HEALTH_TIMEOUT_MS: "3000"
    ports:
      - "7080:7080"
    networks:
      - ippan-full-stack
    logging: *default-logging

    ippan-ui:
      image: ippan-ui:ci
      build:
        context: ../apps/unified-ui
        dockerfile: Dockerfile
      depends_on:
        - ippan-gateway
      restart: unless-stopped
      environment:
        NODE_ENV: "production"
        PORT: "3001"
        NEXT_PUBLIC_API_BASE_URL: "http://ippan-gateway:7080/api"
        NEXT_PUBLIC_WS_URL: "ws://ippan-gateway:7080/ws"
        NEXT_PUBLIC_GATEWAY_URL: "http://ippan-gateway:7080/api"
        NEXT_PUBLIC_ASSET_PREFIX: ""
        NEXT_PUBLIC_ENABLE_FULL_UI: "1"
      ports:
        - "3001:3001"
      networks:
        - ippan-full-stack
      logging: *default-logging

networks:
  ippan-full-stack:
    driver: bridge

volumes:
  node-bootstrap-data:
  node-2-data:
  node-3-data:
