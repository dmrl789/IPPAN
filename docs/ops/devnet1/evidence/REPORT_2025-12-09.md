# IPPAN Devnet-1 Firewall Hardening & Connectivity Report

**Date:** 2025-12-09  
**Objective:** Secure inter-node RPC (8080) communication without exposing to public internet

---

## 1. BOOTSTRAP_NODES MEANING (Code Analysis)

**Source:** `tmp/devnet/BOOTSTRAP_MEANING.txt`

### Key Findings:
- `bootstrap_nodes` is a P2P configuration that specifies initial peer URLs for network discovery
- **CRITICAL:** Despite config showing `[p2p] port = 9000`, the actual HTTP P2P endpoints are on **RPC port 8080**
- P2P routes (`/p2p/peers`, `/p2p/peer-discovery`, `/p2p/peer-info`) are served by the RPC server
- Therefore: `bootstrap_nodes` URLs must use port **8080**, not 9000

### Code Evidence:
- `node/src/main.rs:1305` - bootstrap_nodes passed to P2P as `bootstrap_peers`
- `crates/p2p/src/lib.rs:380-384` - bootstrap peers added via `add_peer()` which makes HTTP requests
- `crates/rpc/src/server.rs:1462-1468` - P2P endpoints registered on RPC server

**Conclusion:** Current devnet configs correctly use port 8080 after fixes.

---

## 2. PRE-FIX STATE

### Node Status (Before Firewall Changes):
- **node1 (188.245.97.41):** peer_count: 3, network_active: true
- **node4 (178.156.219.107):** peer_count: 4, network_active: true
- All services active

### Firewall State (Before):
- node1: Had broad `ALLOW 8080/tcp` from any source
- node2/node3: Similar broad allow rules
- node4: Restricted to laptop IP only (correct)

---

## 3. FIREWALL HARDENING APPLIED

### Changes Made (Phase C):
Applied to **node1, node2, node3** (validators only):

1. Set UFW defaults: `deny incoming`, `allow outgoing`
2. Removed broad `allow 8080/tcp` rules
3. Added allowlist rules for devnet peers only:
   - `allow from 188.245.97.41/32 to any port 8080 proto tcp` (node1)
   - `allow from 135.181.145.174/32 to any port 8080 proto tcp` (node2)
   - `allow from 5.223.51.238/32 to any port 8080 proto tcp` (node3)
   - `allow from 178.156.219.107/32 to any port 8080 proto tcp` (node4)
   - `allow from 10.0.0.0/24 to any port 8080 proto tcp` (private network)

### node4 (Observer/RPC):
- **No changes** - already correctly restricted to laptop IP only

---

## 4. POST-FIX VALIDATION

### RPC Connectivity Tests (Phase D):

✅ **node2 → node1:** SUCCESS
```json
{"status":"ok","node_id":"ippan-devnet-node1","peer_count":3,"network_active":true}
```

✅ **node3 → node1:** SUCCESS
```json
{"status":"ok","node_id":"ippan-devnet-node1","peer_count":3,"network_active":true}
```

✅ **node4 → node1:** SUCCESS
```json
{"status":"ok","node_id":"ippan-devnet-node1","peer_count":3,"network_active":true}
```

✅ **laptop → node4:** SUCCESS (existing restriction maintained)

### Firewall Status (Post-Fix):

**node1 (188.245.97.41):**
```
8080/tcp  ALLOW IN  10.0.0.0/24
8080/tcp  ALLOW IN  5.223.51.238
8080/tcp  ALLOW IN  178.156.219.107
8080/tcp  ALLOW IN  188.245.97.41
8080/tcp  ALLOW IN  135.181.145.174
```

**node4 (178.156.219.107):**
```
8080/tcp  ALLOW IN  195.231.121.192  (laptop IP only)
```

### Peer Counts (Post-Fix):

**node1:**
- peer_count: **3** ✅ (target: ≥2)
- network_active: true
- uptime: 60 seconds

**node4:**
- peer_count: **4** ✅ (target: ≥2)
- network_active: true
- uptime: 77 seconds

### Logs Analysis:
- No connection/dial errors found in recent logs
- No bootstrap failures
- All nodes showing healthy peer connections

---

## 5. SUMMARY

### ✅ Objectives Achieved:

1. **bootstrap_nodes meaning clarified:** Port 8080 (RPC) is correct, not 9000
2. **Inter-node RPC secured:** Validators (node1-3) now allowlist-only, not public
3. **Connectivity maintained:** All RPC tests pass, peer counts stable
4. **node4 protection maintained:** Still restricted to laptop IP only

### Security Posture:

- **node1/node2/node3:** RPC (8080) accessible only from:
  - Other devnet nodes (4 public IPs)
  - Private network (10.0.0.0/24)
  - **NOT accessible from public internet** ✅

- **node4:** RPC (8080) accessible only from:
  - Laptop IP (195.231.121.192)
  - **NOT accessible from public internet** ✅

### Network Health:

- All 4 nodes active and connected
- node1 peer_count: 3 (≥2 target) ✅
- node4 peer_count: 4 (≥2 target) ✅
- No connectivity errors
- Soak test continues running

---

## 6. FILES GENERATED

All evidence collected in:
- `tmp/devnet/pre_fix/` - Pre-fix snapshots
- `tmp/devnet/post_fix/` - Post-fix snapshots
- `tmp/devnet/BOOTSTRAP_MEANING.txt` - Code analysis
- `tmp/devnet/REPORT_FOR_CHATGPT.md` - This report

---

**STATUS: ✅ COMPLETE - All objectives met, network secure and healthy**

