# Verifier Selection Determinism Attestation

## Proof Bundle #2B-B

**Status**: ✅ PASSED

**Date**: 2025-12-31T17:06:59Z (UTC)

---

## Environment

| Parameter | Value |
|-----------|-------|
| Chain ID / Network | `ippan-devnet-proof-v1` |
| Consensus Mode | DLC |
| Validator Count | 4 |
| Host Count | 4 |
| Build SHA | `4bd6132434ca52f5ed6d75601a0f8c0168307f3d` |

### Hosts

| Host | IP Address | Validator ID |
|------|------------|--------------|
| H1 | 188.245.97.41 | `2375fcf66a2a70ae2d1f61cd2ac886368f06507e046c8de46d9b935c39995d07` |
| H2 | 135.181.145.174 | `ae232813d973c4c3a82a4cdf3dcf80b376a776fab6af56c743ddff9b82a83c6a` |
| H3 | 5.223.51.238 | `99a03e57ab842364122713227ee54e84608879bacdfd6b8e01d13f5a8c56d676` |
| H4 | 178.156.219.107 | `790df385aad79d22844a2ae85aa9ad2fdbfcb28e055f651031904c9a0bf8c02b` |

---

## Proof Result

For `selection_round_id = 1`, all 4 hosts computed **identical** values:

| Field | Value |
|-------|-------|
| `selection_round_id` | 1 |
| `selection_seed` | `0df8e26cf7d86eeb3f45eafe28a3e41f55a66e2abd4eddd4f2f091961489394d` |
| `round_primary_id` | `99a03e57ab842364122713227ee54e84608879bacdfd6b8e01d13f5a8c56d676` |
| `selection_commitment` | `51021cc72a9631a555b6da24aa5333b9e412c5e408f84b6ca34c20022e7a793a` |

---

## What Was Fixed

Two determinism bugs were discovered and fixed during this proof:

### 1. HashMap Iteration Order (`crates/consensus/src/dgbdt.rs`)

**Problem**: When all validators had equal reputation scores (`total_score == 0`), the fallback returned `scores.keys().next()` which uses HashMap iteration order — **not deterministic across machines**.

**Fix**: Added canonical `rank_candidates()` function that sorts by (score DESC, validator_id ASC):

```rust
fn rank_candidates(scores: &HashMap<ValidatorId, i32>) -> Vec<(ValidatorId, i32)> {
    let mut candidates: Vec<_> = scores.iter().map(|(id, s)| (*id, *s)).collect();
    candidates.sort_by(|(id_a, score_a), (id_b, score_b)| {
        score_b.cmp(score_a).then_with(|| id_a.cmp(id_b))
    });
    candidates
}
```

### 2. Startup Initialization Order (`node/src/main.rs`)

**Problem**: The DLC engine computed initial selection during `start()` before validator metrics were seeded. With empty metrics, each node fell back to `self.validator_id` as primary — guaranteeing divergence.

**Fix**: Seed validator metrics **before** calling `dlc_integrated.start()`:

```rust
// Store DLC handle BEFORE start() so we can seed metrics first
dlc_handle = Some(dlc_integrated.get_dlc());

// Seed validator metrics BEFORE start() computes initial selection
if let Some(handle) = &dlc_handle {
    seed_dlc_validator_metrics(handle, &discovered_validators);
}

// Start DLC consensus (will now have metrics for all validators)
dlc_integrated.start().await?;
```

---

## Proof Archive

| File | SHA-256 |
|------|---------|
| `proof_2B-B_verifier-selection_dlc_2025-12-31.tar.gz` | `7c3e81e1eb945c049c0bf78a0a699511746e0aa92a12f14a067cb9d49e6bd4d3` |

---

## Reproduction Commands

### Prerequisites

- SSH access to all 4 hosts as root
- `SHARED_VALIDATOR_IDS` environment variable with all 4 validator IDs

### Steps

```bash
cd docs/ops/multinode

# 1. Reset with shared validator IDs
SHARED_VALIDATOR_IDS="2375fcf66a2a70ae2d1f61cd2ac886368f06507e046c8de46d9b935c39995d07,ae232813d973c4c3a82a4cdf3dcf80b376a776fab6af56c743ddff9b82a83c6a,99a03e57ab842364122713227ee54e84608879bacdfd6b8e01d13f5a8c56d676,790df385aad79d22844a2ae85aa9ad2fdbfcb28e055f651031904c9a0bf8c02b" \
./reset_single_instance_devnet.sh reset

# 2. Run verification
./verifier_selection_check_ssh.sh
```

### Manual Verification

```bash
for h in 188.245.97.41 135.181.145.174 5.223.51.238 178.156.219.107; do
  echo "== $h =="
  ssh root@$h "curl -sf http://127.0.0.1:8081/lanes/groups/0 | \
    jq -c '{selection_round_id, selection_commitment, round_primary_id, selection_seed}'"
done
```

---

## Claim

> **IPPAN DLC verifier selection is multi-host deterministic across 4 devnet hosts when configured with the same validator set and seeded metrics. For the same `selection_round_id`, all hosts compute identical `selection_seed`, `round_primary_id`, and `selection_commitment`, evidenced by an archived proof bundle with SHA-256 `7c3e81e1eb945c049c0bf78a0a699511746e0aa92a12f14a067cb9d49e6bd4d3`.**

---

## Attestation

- **Proof generated by**: Automated verification script
- **Reviewed by**: Development team
- **Date**: 2025-12-31
