name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write
  checks: write

jobs:
  security-scan:
    name: Filesystem Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Rust: advisories, bans, sources, licenses via cargo-deny ---
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Rust Security & License Check (cargo-deny)
        run: |
          echo "üîç Running cargo-deny checks..."
          if [ -f deny.toml ]; then
            cargo deny check --config deny.toml 2>&1 | tee deny-output.txt
          else
            cargo deny check licenses bans sources advisories 2>&1 | tee deny-output.txt
          fi

          # cargo-deny exit codes:
          # 0 = success, 1 = warnings, >=2 = errors
          ec=${PIPESTATUS[0]}
          if [ $ec -eq 0 ]; then
            echo "‚úÖ cargo-deny checks passed"
          elif [ $ec -eq 1 ]; then
            echo "‚ö†Ô∏è cargo-deny warnings present (continuing)"
            exit 0
          else
            echo "‚ùå cargo-deny reported errors"
            exit $ec
          fi

      # --- Node.js: npm audit + artifact ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/gateway/package-lock.json

      - name: Install gateway dependencies
        if: always()
        run: |
          if [ -d "apps/gateway" ]; then
            cd apps/gateway
            if [ -f package-lock.json ]; then
              npm ci --no-audit --no-fund
            else
              npm install --no-audit --no-fund
            fi
          else
            echo "‚ÑπÔ∏è No apps/gateway directory; skipping install"
          fi

      - name: Run npm audit
        if: always()
        run: |
          if [ -d "apps/gateway" ]; then
            cd apps/gateway
            echo "üîç Running npm audit..."
            npm audit --audit-level=moderate --json > audit-results.json 2>&1 || true
            crit=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json 2>/dev/null || echo 0)
            if [ "$crit" -gt 0 ]; then
              echo "‚ö†Ô∏è Found $crit critical vulnerabilities in Node.js deps"
            else
              echo "‚úÖ No critical vulnerabilities found"
            fi
          else
            echo "‚ÑπÔ∏è No apps/gateway directory; skipping audit"
          fi

      - name: Upload dependency scan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: |
            deny-output.txt
            apps/gateway/audit-results.json
          retention-days: 30
          if-no-files-found: warn

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Rust License Check (cargo-deny)
        run: |
          cargo install cargo-deny --locked
          if [ -f deny.toml ]; then
            cargo deny check --config deny.toml
          else
            cargo deny check licenses bans sources
          fi

      - name: Node.js License Check
        working-directory: apps/gateway
        run: |
          if [ -f package.json ]; then
            npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Unlicense;MPL-2.0;CC0-1.0' || true
          else
            echo "‚ÑπÔ∏è No package.json; skipping Node license check"
          fi
